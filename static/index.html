<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê¸ˆìœµ ì •ë³´ ì„œë¹„ìŠ¤</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§ (ê°„ë‹¨í•˜ê²Œ êµ¬ì„±) */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #2c3e50; }
        h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 40px; color: #34495e; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa; }
        .card h3 { margin-top: 0; }
        .news-list, .keyword-list { list-style-type: none; padding: 0; }
        .news-list li, .keyword-list li { padding: 8px 0; border-bottom: 1px dashed #ccc; display: flex; justify-content: space-between; align-items: center; }
        .news-list a { text-decoration: none; color: #2980b9; font-weight: 500; }
        .news-list a:hover { text-decoration: underline; }
        .news-list .count { font-size: 0.9em; color: #c0392b; font-weight: bold; margin-left: 10px;}
        .keyword-list .rank { font-weight: bold; margin-right: 10px; }
        #search-section input { padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        #search-section button { padding: 10px 15px; border: none; background-color: #3498db; color: white; border-radius: 4px; cursor: pointer; }
        #stock-details { margin-top: 20px; background-color: #ecf0f1; padding: 20px; border-radius: 5px; }
        #ai-insight { margin-top: 15px; border: 1px solid #95a5a6; padding: 15px; border-radius: 5px; white-space: pre-wrap; line-height: 1.6; }
        .theme-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .theme-buttons button { padding: 8px 12px; border: 1px solid #7f8c8d; background-color: transparent; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .theme-buttons button:hover, .theme-buttons button.active { background-color: #34495e; color: white; border-color: #34495e;}
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸ“ˆ AI ê¸ˆìœµ ì •ë³´ ì„œë¹„ìŠ¤ ğŸ“‰</h1>
        </header>

        <section id="search-section">
            <h2>ì¢…ëª© ê²€ìƒ‰</h2>
            <form id="stock-search-form">
                <input type="text" id="stock-code-input" placeholder="ì¢…ëª©ì½”ë“œ ì…ë ¥ (ì˜ˆ: 005930)" required>
                <button type="submit">ê²€ìƒ‰</button>
            </form>
            <div id="stock-details"></div>
            <div id="ai-insight"></div>
        </section>

        <div class="grid-container">
            <div class="card">
                <h3>ğŸŒ ê±°ì‹œê²½ì œ ë©”ì¸ ì´ìŠˆ</h3>
                <ul id="macro-news" class="news-list"></ul>
            </div>
            <div class="card">
                <h3>ğŸ”¥ ì¸ê¸° ê¸°ì‚¬</h3>
                <ul id="popular-news" class="news-list"></ul>
            </div>
            <div class="card">
                <h3>ğŸ” ì¸ê¸° ê²€ìƒ‰ì–´ (24H)</h3>
                <ol id="top-keywords" class="keyword-list"></ol>
            </div>
        </div>

        <section>
            <h2>í…Œë§ˆë³„ ìµœì‹  ê¸°ì‚¬</h2>
            <div id="theme-buttons" class="theme-buttons"></div>
            <ul id="themed-news" class="news-list"></ul>
        </section>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        // ë°±ì—”ë“œ API í˜¸ì¶œ í•¨ìˆ˜ë“¤
        const api = {
            get: (path) => fetch(`${API_BASE_URL}${path}`).then(res => res.json()),
            post: (path) => fetch(`${API_BASE_URL}${path}`, { method: 'POST' })
        };

        // ê¸°ì‚¬ ëª©ë¡ì„ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function renderArticles(elementId, articles) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
            if (!articles || articles.length === 0) {
                container.innerHTML = '<li>ìµœì‹  ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            articles.forEach(article => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = article.url;
                a.textContent = article.title;
                a.target = '_blank'; // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                a.addEventListener('click', () => {
                    // í´ë¦­ ì‹œ ì¡°íšŒìˆ˜ ì¦ê°€ API í˜¸ì¶œ (ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
                    api.post(`/api/articles/${article.id}/click`);
                });
                li.appendChild(a);

                // ì¸ê¸° ê¸°ì‚¬ì¸ ê²½ìš°ì—ë§Œ ì¡°íšŒìˆ˜ í‘œì‹œ
                if (elementId === 'popular-news' && article.click_count > 0) {
                    const span = document.createElement('span');
                    span.className = 'count';
                    span.textContent = `${article.click_count}íšŒ`;
                    li.appendChild(span);
                }
                container.appendChild(li);
            });
        }
        
        // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ì‹¤í–‰ë  í•¨ìˆ˜
        async function initializePage() {
            // 1. ê±°ì‹œê²½ì œ ë‰´ìŠ¤ ë¡œë“œ
            const macroNews = await api.get('/api/news/macro');
            renderArticles('macro-news', macroNews);

            // 2. ì¸ê¸° ê¸°ì‚¬ ë¡œë“œ
            const popularNews = await api.get('/api/news/popular');
            renderArticles('popular-news', popularNews);

            // 3. ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
            const topKeywords = await api.get('/api/keywords/top');
            const keywordsContainer = document.getElementById('top-keywords');
            keywordsContainer.innerHTML = '';
            topKeywords.forEach((kw, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="rank">${index + 1}</span> ${kw.keyword} <span>${kw.count}íšŒ</span>`;
                keywordsContainer.appendChild(li);
            });

            // 4. í…Œë§ˆ ë²„íŠ¼ ìƒì„±
            const themes = await api.get('/api/themes');
            const themesContainer = document.getElementById('theme-buttons');
            themes.forEach(theme => {
                const button = document.createElement('button');
                button.textContent = theme;
                button.addEventListener('click', async (event) => {
                    // ëª¨ë“  ë²„íŠ¼ì—ì„œ 'active' í´ë˜ìŠ¤ ì œê±°
                    document.querySelectorAll('.theme-buttons button').forEach(btn => btn.classList.remove('active'));
                    // í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'active' í´ë˜ìŠ¤ ì¶”ê°€
                    event.target.classList.add('active');
                    
                    const themedNews = await api.get(`/api/news/theme/${theme}`);
                    renderArticles('themed-news', themedNews);
                });
                themesContainer.appendChild(button);
            });
            // ì²«ë²ˆì§¸ í…Œë§ˆ ë²„íŠ¼ì„ ê¸°ë³¸ìœ¼ë¡œ í´ë¦­
            if (themesContainer.firstChild) {
                themesContainer.firstChild.click();
            }
        }

        // ê²€ìƒ‰ í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('stock-search-form').addEventListener('submit', async (e) => {
            e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë§‰ê¸°
            const stockCode = document.getElementById('stock-code-input').value;
            const detailsContainer = document.getElementById('stock-details');
            const insightContainer = document.getElementById('ai-insight');
            
            detailsContainer.innerHTML = 'ğŸ” ê²€ìƒ‰ ì¤‘...';
            insightContainer.innerHTML = '';

            try {
                // ìƒì„¸ ì •ë³´, AI ì¸ì‚¬ì´íŠ¸ ë™ì‹œ ìš”ì²­
                const [details, insight] = await Promise.all([
                    api.get(`/api/stock/search/${stockCode}`),
                    api.get(`/api/insight/${stockCode}`)
                ]);

                if (details.detail || insight.detail) {
                    throw new Error('ì¢…ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                detailsContainer.innerHTML = `
                    <h3>${details.name} (${details.code})</h3>
                    <p><strong>í˜„ì¬ê°€:</strong> ${details.price} | <strong>ì‹œê°€ì´ì•¡:</strong> ${details.market_cap}</p>
                    <p><strong>PER:</strong> ${details.per} | <strong>PBR:</strong> ${details.pbr}</p>
                `;
                insightContainer.textContent = insight.report;

            } catch (error) {
                detailsContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
                insightContainer.innerHTML = '';
            }
        });

        // DOMì´ ì™„ì „íˆ ë¡œë“œë˜ë©´ í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>